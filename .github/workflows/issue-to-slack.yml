name: Issue → Slack (BUG REQUESTS on creation)

on:
  issues:
    types: [opened, labeled]

jobs:
  notify_on_create_bug_requests:
    runs-on: ubuntu-latest
    permissions:
      issues: read
    steps:
      - name: Check "BUG REQUESTS" label at creation
        id: guard
        env:
          EVENT_JSON: ${{ toJson(github.event) }}
          CREATION_LABEL: "bug"   # <- change ici si besoin
        run: |
          HAS_LABEL=$(jq -r --arg WANT "$CREATION_LABEL" '.issue.labels[].name | select(. == $WANT)' <<<"$EVENT_JSON" | wc -l)
          if [ "$HAS_LABEL" -ge 1 ]; then
            echo "send=yes" >> $GITHUB_OUTPUT
          else
            echo "send=no" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack (creation with BUG REQUESTS)
        if: steps.guard.outputs.send == 'yes'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          EVENT_JSON: ${{ toJson(github.event) }}
          REPO: ${{ github.repository }}
        run: |
          TITLE=$(jq -r '.issue.title' <<<"$EVENT_JSON")
          URL=$(jq -r '.issue.html_url' <<<"$EVENT_JSON")
          AUTHOR=$(jq -r '.issue.user.login' <<<"$EVENT_JSON")
          LABELS=$(jq -r '[.issue.labels[].name] | join(", ")' <<<"$EVENT_JSON")
          BODY=$(jq -r '.issue.body // ""' <<<"$EVENT_JSON" | head -c 700)

          jq -n \
            --arg repo "$REPO" \
            --arg title "$TITLE" \
            --arg url "$URL" \
            --arg author "$AUTHOR" \
            --arg labels "$LABELS" \
            --arg body "$BODY" \
            '{
              text: "Nouvelle BUG REQUEST créée",
              blocks: [
                { "type":"section", "text":{"type":"mrkdwn", "text":":beetle: *Nouvelle BUG REQUEST*"} },
                { "type":"section", "text":{"type":"mrkdwn", "text":"*Repo:* `\($repo)`\n*Titre:* <\($url)|\($title)>\n*Auteur:* \($author)\n*Labels:* \($labels)"} },
                { "type":"section", "text":{"type":"mrkdwn", "text":"*Description:*\n```\($body)```"} }
              ]
            }' \
          | curl -s -X POST -H 'Content-type: application/json' --data @- "$SLACK_WEBHOOK_URL" -o /dev/stderr -w "HTTP %{http_code}\n"
